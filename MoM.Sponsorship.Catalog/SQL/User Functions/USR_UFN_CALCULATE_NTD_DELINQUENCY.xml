<SQLFunctionSpec
	xmlns="bb_appfx_sqlfunction"
	xmlns:common="bb_appfx_commontypes" 
	ID="fac8eeb6-d8f8-4697-9463-16b92f1e6878"
	Name="USR_UFN_CALCULATE_NTD_DELINQUENCY"
	Description="Calculates the number of days delinquent based on next transaction date."
	Author="Memphis Sellers"
	DBFunctionName="USR_UFN_CALCULATE_NTD_DELINQUENCY"
	>

	<!-- 
	Remarks:  This returns the number of days delinquent based on the given NTD date. 
				A negative number means paid ahead. 
				0 means current.
				Any number >0 is how many days delinquent.

	History:
	Date            Modified By     Comments
	15-Nov-2012		Memphis			Initial Version
	-->	

	<CreateFunctionSQL>
		<![CDATA[
create function dbo.USR_UFN_CALCULATE_NTD_DELINQUENCY(
	@NTD_DATE date
)
returns integer
with execute as caller
as begin
	-- do work here and return a value
	declare @daysDelinquent int;

	-- create the test date, based on current month/year/date:
	declare @testDate date = CONVERT(Date, GETDATE());
	declare @compareDateCurrent date;
	declare @compareDateFuture date;

	if @NTD_DATE is not null
		begin
			-- need to get the comparison dates for 'current': 
			--   all cash payments are due on the 17th, so use that as our base, current date
			if DATEPART(DAY, @testDate) <> 17
			begin
				set @compareDateCurrent = DateAdd(YY, DATEPART(YEAR,@testDate)-1900, DateAdd(m,  DATEPART(MONTH, @testDate) - 1, 17-1)) 
				set @compareDateFuture = DATEADD(MONTH,1,@compareDateCurrent)
			end

			-- check if the NTD is in the current month
			if @NTD_DATE BETWEEN @compareDateCurrent AND @compareDateFuture
				begin
					set @daysDelinquent = 0;
				end
			else
				begin
					-- it's not current, so calculate how many days delinquent it is
					set @daysDelinquent =  DATEDIFF(DAY, @NTD_DATE, @compareDateCurrent);
				end
		end
	else
		set @daysDelinquent = 0;
		
	return @daysDelinquent;
	
end
		]]>
	</CreateFunctionSQL>

</SQLFunctionSpec>
