<AddDataFormTemplateSpec 
	xmlns="bb_appfx_adddataformtemplate"
	xmlns:c="bb_appfx_commontypes" 
	ID="7cd5ccc3-3de5-46a6-8c9e-7659d2c028a1" 
	Name="Merge Multiple Sponsorship Commitments Add Data Form"
	Description="A data form for adding merge multiple sponsorship commitments records" 
	Author="Zuri Group\Ken Swift"
	DataFormInstanceID="2550b89f-5e59-411f-8fc2-7da80f56f80a" 
	RecordType="Merge Multiple Sponsorship Commitments"
	c:SecurityUIFolder="Merge Multiple Sponsorship Commitments"
	FormHeader="Add a merge multiple sponsorship commitments"
	>

	<SPDataForm>
		<!-- describe the save SP -->
		<SaveImplementation SPName="USR_USP_DATAFORMTEMPLATE_ADD_MERGEMULTIPLESPONSORSHIPCOMMITMENTS">
			<c:CreateProcedureSQL>
				<![CDATA[
create procedure dbo.USR_USP_DATAFORMTEMPLATE_ADD_MERGEMULTIPLESPONSORSHIPCOMMITMENTS
(
    @ID uniqueidentifier = null output,
  	@CONTEXTID uniqueidentifier,
    @CHANGEAGENTID uniqueidentifier = null,
  	@MERGECOMMITMENTS xml,
	  @EARLIESTSTARTDATE date = '2009-01-01',
    @DELETERECORDS bit = 0
)
as

set nocount on;

declare  @NUMBEREDITED int 
declare @NUMBERDELETED int 


if @ID is null
    set @ID = newid()

if @CHANGEAGENTID is null  
    exec dbo.USP_CHANGEAGENT_GETORCREATECHANGEAGENT @CHANGEAGENTID output

declare @CURRENTDATE datetime
set @CURRENTDATE = getdate()

begin try
    declare @COMMITMENT table(ID nvarchar(100))
    insert into @COMMITMENT
      select 
        T.mergecommitments.value('(COMMITMENTID)[1]','nvarchar(100)')   
      from
        @MERGECOMMITMENTS.nodes('/MERGECOMMITMENTS/ITEM') T(mergecommitments)

    declare @CONSTITUENTCOUNT int
    set @CONSTITUENTCOUNT = (select count(*) from SPONSORSHIPCOMMITMENT SC inner join @COMMITMENT C on SC.LOOKUPID = C.ID where SC.CONSTITUENTID != @CONTEXTID)
    if (@CONSTITUENTCOUNT > 0)
    begin
      raiserror ('One or more of the commitments does not belong to this sponsor', 
                    16, -- Severity.
                    1 -- State.
      );    
    end

    exec USR_USP_MERGEMULTIPLESPONSORSHIPCOMMITMENTS @MERGECOMMITMENTS, @EARLIESTSTARTDATE, @DELETERECORDS, @NUMBEREDITED output, @NUMBERDELETED output, @CHANGEAGENTID
end try

begin catch
    exec dbo.USP_RAISE_ERROR
    return 1
end catch

return 0				
				]]>
			</c:CreateProcedureSQL>
		</SaveImplementation>
	</SPDataForm>

	<!-- describe the context ID for this form (if applicable), which corresponds to a parameter in the SP. -->
	<Context ContextRecordType="Sponsor" RecordIDParameter="CONTEXTID"/>

	<!-- describe fields on the form, which correspond to parameters on the SP.  Note that system parameters 
	like the context @ID, @CONTEXTID, and @CURRENTAPPUSERID need not be listed. -->
	<FormMetaData xmlns="bb_appfx_commontypes">
		<FormFields>
        <FormField FieldID="MERGECOMMITMENTS" Caption="Merge commitment" DataType="XML" Required="true">
          <Collection>
            <Fields>
              <FormField FieldID="COMMITMENTID" Caption="Commitment" DataType="String" Required="true" />
            </Fields>
          </Collection>
        </FormField>
        <FormField FieldID="EARLIESTSTARTDATE" Caption="Earliest startdate" DataType="Date" DefaultValueText="2009-01-01" Required="true"/>
        <FormField FieldID="DELETERECORDS" Caption="Delete records" DataType="Boolean" DefaultValueText="0"/>
      </FormFields>
	</FormMetaData>

</AddDataFormTemplateSpec>